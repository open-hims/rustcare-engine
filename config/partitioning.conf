# RustCare Engine - Partition Configuration
# Configuration file for table partitioning settings
# Edit this file to customize partition behavior for your environment

# =============================================================================
# DATABASE CONNECTION
# =============================================================================
# Database connection URL (can be overridden by DATABASE_URL environment variable)
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/rustcare_dev

# =============================================================================
# PARTITION STRATEGIES
# =============================================================================

# Audit Log Partitioning (HIPAA Compliance)
AUDIT_LOG_PARTITION_TYPE=monthly           # monthly, weekly, daily
AUDIT_LOG_RETENTION_YEARS=7               # HIPAA requires 7 years
AUDIT_LOG_PARTITIONS_AHEAD=6              # Create 6 months ahead

# Sessions Partitioning (High Turnover)
SESSIONS_PARTITION_TYPE=daily              # daily, weekly
SESSIONS_RETENTION_DAYS=90                 # Keep sessions for 90 days
SESSIONS_PARTITIONS_AHEAD=14               # Create 14 days ahead

# Refresh Tokens Partitioning (Medium Volume)
TOKENS_PARTITION_TYPE=weekly               # weekly, daily
TOKENS_RETENTION_DAYS=60                   # Keep tokens for 60 days
TOKENS_PARTITIONS_AHEAD=8                  # Create 8 weeks ahead

# Rate Limits Partitioning (Short-lived)
RATE_LIMITS_PARTITION_TYPE=daily           # daily, hourly
RATE_LIMITS_RETENTION_DAYS=7               # Keep rate limits for 7 days
RATE_LIMITS_PARTITIONS_AHEAD=14            # Create 14 days ahead

# =============================================================================
# MAINTENANCE SCHEDULE
# =============================================================================

# Automatic partition creation (requires pg_cron extension)
AUTO_CREATE_PARTITIONS=true                # Enable automatic partition creation
CREATE_PARTITIONS_CRON="0 1 * * *"        # Daily at 1 AM

# Automatic partition cleanup (requires pg_cron extension)
AUTO_CLEANUP_PARTITIONS=true               # Enable automatic cleanup
CLEANUP_PARTITIONS_CRON="0 2 * * 0"       # Weekly on Sunday at 2 AM

# Table maintenance
AUTO_ANALYZE_TABLES=true                   # Auto-analyze partitioned tables
ANALYZE_TABLES_CRON="0 3 * * 0"          # Weekly on Sunday at 3 AM

# =============================================================================
# PERFORMANCE SETTINGS
# =============================================================================

# Partition pruning settings
ENABLE_CONSTRAINT_EXCLUSION=true          # Enable constraint exclusion for older PostgreSQL
ENABLE_PARTITION_PRUNING=true             # Enable partition pruning (PostgreSQL 11+)

# Memory settings for partition operations
WORK_MEM_PARTITION_OPS="256MB"            # Memory for partition operations
MAINTENANCE_WORK_MEM="1GB"                # Memory for maintenance operations

# Parallel processing
MAX_PARALLEL_WORKERS_PER_GATHER=4         # Parallel workers for queries
MAX_PARALLEL_MAINTENANCE_WORKERS=2        # Parallel workers for maintenance

# =============================================================================
# MONITORING AND ALERTING
# =============================================================================

# Partition size monitoring
WARN_PARTITION_SIZE_GB=10                 # Warn when partition exceeds this size
CRITICAL_PARTITION_SIZE_GB=50             # Critical alert when partition exceeds this size

# Partition count monitoring
WARN_PARTITION_COUNT=100                  # Warn when total partitions exceed this
CRITICAL_PARTITION_COUNT=500              # Critical alert when partitions exceed this

# Failed partition operations
ALERT_ON_PARTITION_FAILURES=true         # Send alerts for partition operation failures
ALERT_EMAIL=""                           # Email for partition alerts (if configured)

# =============================================================================
# BACKUP AND RECOVERY
# =============================================================================

# Partition-aware backup settings
BACKUP_PARTITIONS_INDIVIDUALLY=false     # Backup each partition separately
COMPRESS_PARTITION_BACKUPS=true          # Compress partition backups
BACKUP_RETENTION_DAYS=30                 # Keep partition backups for 30 days

# Point-in-time recovery
ENABLE_PARTITION_PITR=true               # Enable PITR for partitioned tables
PITR_ARCHIVE_MODE="on"                   # WAL archiving for PITR

# =============================================================================
# HIPAA COMPLIANCE SETTINGS
# =============================================================================

# Audit log compliance
AUDIT_LOG_IMMUTABLE=true                 # Make audit log partitions immutable after creation
AUDIT_LOG_ENCRYPTION=true               # Encrypt audit log partitions at rest
AUDIT_LOG_VERIFICATION=true             # Enable audit log integrity verification

# Data retention compliance
ENFORCE_RETENTION_POLICIES=true         # Strictly enforce data retention policies
RETENTION_OVERRIDE_REQUIRES_APPROVAL=true # Require approval to override retention

# Access logging
LOG_PARTITION_ACCESS=true               # Log all partition access for audit
LOG_PARTITION_OPERATIONS=true          # Log partition creation/deletion

# =============================================================================
# ENVIRONMENT-SPECIFIC OVERRIDES
# =============================================================================

# Development environment (less strict)
[development]
AUDIT_LOG_RETENTION_YEARS=1
SESSIONS_RETENTION_DAYS=30
TOKENS_RETENTION_DAYS=30
RATE_LIMITS_RETENTION_DAYS=3
AUTO_CLEANUP_PARTITIONS=true

# Staging environment (moderate settings)
[staging]
AUDIT_LOG_RETENTION_YEARS=2
SESSIONS_RETENTION_DAYS=60
TOKENS_RETENTION_DAYS=45
RATE_LIMITS_RETENTION_DAYS=5
AUTO_CLEANUP_PARTITIONS=true

# Production environment (full compliance)
[production]
AUDIT_LOG_RETENTION_YEARS=7
SESSIONS_RETENTION_DAYS=90
TOKENS_RETENTION_DAYS=60
RATE_LIMITS_RETENTION_DAYS=7
AUTO_CLEANUP_PARTITIONS=false           # Manual cleanup in production
AUDIT_LOG_IMMUTABLE=true
AUDIT_LOG_ENCRYPTION=true
ENFORCE_RETENTION_POLICIES=true

# =============================================================================
# ADVANCED SETTINGS
# =============================================================================

# Custom partition naming
PARTITION_NAME_FORMAT="YYYY_MM_DD"      # Date format for partition names
PARTITION_PREFIX_AUDIT="audit"          # Custom prefix for audit partitions
PARTITION_PREFIX_SESSIONS="sess"        # Custom prefix for session partitions

# Tablespace management
USE_SEPARATE_TABLESPACES=false         # Use separate tablespaces for partitions
TABLESPACE_AUDIT="audit_data"          # Tablespace for audit partitions
TABLESPACE_SESSIONS="session_data"     # Tablespace for session partitions

# Index management
AUTO_CREATE_PARTITION_INDEXES=true     # Automatically create indexes on new partitions
COPY_PARENT_INDEXES=true              # Copy parent table indexes to partitions
DROP_UNUSED_INDEXES=false             # Drop indexes not used in query plans

# Statistics and planning
AUTO_VACUUM_PARTITIONS=true           # Enable auto-vacuum on partitions
PARTITION_STATISTICS_TARGET=1000      # Statistics target for partition columns
UPDATE_PARTITION_STATISTICS_DAILY=true # Update partition statistics daily

# =============================================================================
# NOTES
# =============================================================================
#
# 1. This configuration file is used by the partition management scripts
# 2. Environment variables override these settings
# 3. HIPAA compliance requires 7-year retention for audit logs
# 4. Adjust retention periods based on your organization's requirements
# 5. Monitor partition sizes to prevent performance degradation
# 6. Test partition operations in staging before applying to production
# 7. Consider using encrypted tablespaces for sensitive data partitions
# 8. Regular maintenance is crucial for optimal partition performance
#
# For more information, see:
# - PostgreSQL Partitioning Documentation
# - HIPAA Data Retention Requirements
# - RustCare Engine Partitioning Guide