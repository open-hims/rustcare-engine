# Cargo configuration for optimized builds and development
# =============================================================================

[env]
# SQLx offline mode for development (no DB needed at compile-time)
SQLX_OFFLINE = "false"

# Coverage settings (only when running coverage)
# LLVM_PROFILE_FILE = "target/llvm-cov-target/cargo-test-%p-%m.profraw"
# CARGO_INCREMENTAL = "0"
# RUSTFLAGS = "-C instrument-coverage -C link-dead-code"

# =============================================================================
# Build Optimization - Faster Compilation
# =============================================================================
[build]
# Use all available CPU cores for parallel compilation
jobs = 8  # Adjust based on your CPU (use `nproc` or sysctl -n hw.ncpu)

# Incremental compilation for faster rebuilds (disabled during coverage)
incremental = true

# Use faster linker for development builds
# Uncomment based on your platform:
[target.x86_64-apple-darwin]
# rustflags = ["-C", "link-arg=-fuse-ld=lld"]  # If you have lld installed

[target.aarch64-apple-darwin]
# rustflags = ["-C", "link-arg=-fuse-ld=lld"]  # If you have lld installed

# =============================================================================
# Profile Optimization
# =============================================================================

# Development profile - optimized for compile speed
[profile.dev]
# Faster compilation, less optimization
opt-level = 0
# Keep debug info
debug = true
# Incremental compilation
incremental = true
# Faster linking
codegen-units = 256
# Don't split debuginfo
split-debuginfo = "unpacked"

# Fast dev profile - some optimization, still fast to compile
[profile.dev-opt]
inherits = "dev"
opt-level = 1
codegen-units = 16

# Release profile - maximum performance
[profile.release]
opt-level = 3
lto = "thin"
codegen-units = 1
strip = "symbols"
panic = "abort"
# Enable fat LTO for final production builds (slower compile, faster runtime)
# lto = "fat"

# Release with debug info for profiling
[profile.release-with-debug]
inherits = "release"
debug = true
strip = "none"

# =============================================================================
# Cargo settings for faster dependency resolution
# =============================================================================
[net]
# Use sparse registry for faster dependency downloads
git-fetch-with-cli = false

[registries.crates-io]
protocol = "sparse"

# =============================================================================
# Platform-specific coverage flags (only when needed)
# =============================================================================
# [target.x86_64-apple-darwin]
# rustflags = ["-C", "instrument-coverage", "-C", "link-dead-code"]

# [target.aarch64-apple-darwin]
# rustflags = ["-C", "instrument-coverage", "-C", "link-dead-code"]

# [target.x86_64-unknown-linux-gnu]
# rustflags = ["-C", "instrument-coverage", "-C", "link-dead-code"]
